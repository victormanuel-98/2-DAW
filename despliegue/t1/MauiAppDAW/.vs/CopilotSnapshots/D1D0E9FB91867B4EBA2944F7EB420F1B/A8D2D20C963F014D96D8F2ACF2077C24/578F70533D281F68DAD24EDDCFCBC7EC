using System.Net.Http.Json;
using System.Text;
using System.Text.RegularExpressions;
using System.Globalization;
using MauiAppDAW.Models;

namespace MauiAppDAW.Services;

public class SwapiService
{
    private readonly HttpClient _httpClient;
    private readonly string? _imageBaseUrl;

    // Expanded-universe fallback data
    private static readonly List<Character> _expandedCharacters = new()
    {
        new Character
        {
            Name = "Darth Nihilus",
            Height = "unknown",
            Mass = "unknown",
            HairColor = "none",
            SkinColor = "pale",
            EyeColor = "black",
            BirthYear = "unknown",
            Gender = "male",
            Url = "https://swapi.dev/api/people/9999/" // fake url for id parsing
        },
        new Character
        {
            Name = "Grand Admiral Thrawn",
            Height = "188",
            Mass = "unknown",
            HairColor = "blue",
            SkinColor = "pale",
            EyeColor = "red",
            BirthYear = "unknown",
            Gender = "male",
            Url = "https://swapi.dev/api/people/9998/"
        }
    };

    private static readonly List<Starship> _expandedStarships = new()
    {
        new Starship { Name = "Ebon Hawk", Model = "Freighter", Manufacturer = "Sith-era shipyards" },
        new Starship { Name = "TIE Defender (Expanded)", Model = "Defender", Manufacturer = "Sienar Fleet Systems" }
    };

    private static readonly List<Planet> _expandedPlanets = new()
    {
        new Planet { Name = "Ravager", Climate = "arid", Terrain = "wasteland" },
        new Planet { Name = "Korriban", Climate = "dry", Terrain = "desert" }
    };

    public SwapiService(HttpClient httpClient, string? imageBaseUrl = null)
    {
        _httpClient = httpClient;
        _imageBaseUrl = imageBaseUrl?.TrimEnd('/');
    }

    public async Task<Character?> GetCharacterAsync(string name, CancellationToken cancellationToken = default)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SwapiResponse<Character>>($"people/?search={Uri.EscapeDataString(name)}", cancellationToken);
            var result = response?.Results?.FirstOrDefault();

            if (result != null)
            {
                ApplyImageUrl(result, "characters");
                return result;
            }

            // Fallback to expanded-universe list (case-insensitive contains)
            var fallback = _expandedCharacters.FirstOrDefault(c => c.Name.Contains(name, StringComparison.OrdinalIgnoreCase));
            if (fallback != null)
                ApplyImageUrl(fallback, "characters");
            return fallback;
        }
        catch (OperationCanceledException) when (cancellationToken.IsCancellationRequested)
        {
            throw;
        }
        catch (Exception)
        {
            // On error, try fallback
            var fallback = _expandedCharacters.FirstOrDefault(c => c.Name.Contains(name, StringComparison.OrdinalIgnoreCase));
            if (fallback != null)
                ApplyImageUrl(fallback, "characters");
            return fallback;
        }
    }

    public async Task<List<Starship>?> GetStarshipsAsync(string name, CancellationToken cancellationToken = default)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SwapiResponse<Starship>>($"starships/?search={Uri.EscapeDataString(name)}", cancellationToken);
            var results = response?.Results;
            if (results != null && results.Count > 0)
            {
                foreach (var r in results) ApplyImageUrl(r, "starships");
                return results;
            }

            // Fallback: return expanded starships matching name
            var fallback = _expandedStarships.Where(s => s.Name.Contains(name, StringComparison.OrdinalIgnoreCase)).ToList();
            if (fallback.Count > 0)
            {
                foreach (var f in fallback) ApplyImageUrl(f, "starships");
                return fallback;
            }

            return null;
        }
        catch
        {
            var fallback = _expandedStarships.Where(s => s.Name.Contains(name, StringComparison.OrdinalIgnoreCase)).ToList();
            if (fallback.Count > 0)
            {
                foreach (var f in fallback) ApplyImageUrl(f, "starships");
                return fallback;
            }
            return null;
        }
    }

    public async Task<List<Planet>?> GetPlanetsAsync(string name, CancellationToken cancellationToken = default)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SwapiResponse<Planet>>($"planets/?search={Uri.EscapeDataString(name)}", cancellationToken);
            var results = response?.Results;
            if (results != null && results.Count > 0)
            {
                foreach (var r in results) ApplyImageUrl(r, "planets");
                return results;
            }

            var fallback = _expandedPlanets.Where(p => p.Name.Contains(name, StringComparison.OrdinalIgnoreCase)).ToList();
            if (fallback.Count > 0)
            {
                foreach (var f in fallback) ApplyImageUrl(f, "planets");
                return fallback;
            }

            return null;
        }
        catch
        {
            var fallback = _expandedPlanets.Where(p => p.Name.Contains(name, StringComparison.OrdinalIgnoreCase)).ToList();
            if (fallback.Count > 0)
            {
                foreach (var f in fallback) ApplyImageUrl(f, "planets");
                return fallback;
            }
            return null;
        }
    }

    private void ApplyImageUrl(object item, string type)
    {
        if (string.IsNullOrWhiteSpace(_imageBaseUrl))
            return;

        string name = item switch
        {
            Character c => c.Name,
            Starship s => s.Name,
            Planet p => p.Name,
            _ => null
        } ?? string.Empty;

        var slug = Slugify(name);
        var imageUrl = $"{_imageBaseUrl}/{type}/{slug}.jpg";

        switch (item)
        {
            case Character c:
                c.ExternalImageUrl = imageUrl;
                break;
            case Starship s:
                s.ExternalImageUrl = imageUrl;
                break;
            case Planet p:
                p.ExternalImageUrl = imageUrl;
                break;
        }
    }

    private static string Slugify(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return string.Empty;

        // Normalize and remove diacritics
        var normalized = input.Normalize(NormalizationForm.FormD);
        var sb = new StringBuilder();
        foreach (var ch in normalized)
        {
            var uc = CharUnicodeInfo.GetUnicodeCategory(ch);
            if (uc != UnicodeCategory.NonSpacingMark)
                sb.Append(ch);
        }
        var cleaned = sb.ToString().Normalize(NormalizationForm.FormC);

        // To lower, replace spaces with hyphens, remove invalid chars
        cleaned = cleaned.ToLowerInvariant();
        cleaned = Regex.Replace(cleaned, "\\s+", "-");
        cleaned = Regex.Replace(cleaned, "[^a-z0-9-_]", string.Empty);
        cleaned = Regex.Replace(cleaned, "-+", "-");
        return cleaned.Trim('-');
    }

    private class SwapiResponse<T>
    {
        public List<T>? Results { get; set; }
    }
}
