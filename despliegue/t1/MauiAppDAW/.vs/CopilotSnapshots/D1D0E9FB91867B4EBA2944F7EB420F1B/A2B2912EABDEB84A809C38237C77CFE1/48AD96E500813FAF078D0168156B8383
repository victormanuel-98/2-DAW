using System.Net.Http.Json;
using MauiAppDAW.Models;

namespace MauiAppDAW.Services;

public class SwapiService
{
    private readonly HttpClient _httpClient;

    // Expanded-universe fallback data
    private static readonly List<Character> _expandedCharacters = new()
    {
        new Character
        {
            Name = "Darth Nihilus",
            Height = "unknown",
            Mass = "unknown",
            HairColor = "none",
            SkinColor = "pale",
            EyeColor = "black",
            BirthYear = "unknown",
            Gender = "male",
            Url = "https://swapi.dev/api/people/9999/" // fake url for id parsing
        },
        new Character
        {
            Name = "Grand Admiral Thrawn",
            Height = "188",
            Mass = "unknown",
            HairColor = "blue",
            SkinColor = "pale",
            EyeColor = "red",
            BirthYear = "unknown",
            Gender = "male",
            Url = "https://swapi.dev/api/people/9998/"
        }
    };

    private static readonly List<Starship> _expandedStarships = new()
    {
        new Starship { Name = "Ebon Hawk", Model = "Freighter", Manufacturer = "Sith-era shipyards" },
        new Starship { Name = "TIE Defender (Expanded)", Model = "Defender", Manufacturer = "Sienar Fleet Systems" }
    };

    private static readonly List<Planet> _expandedPlanets = new()
    {
        new Planet { Name = "Ravager", Climate = "arid", Terrain = "wasteland" },
        new Planet { Name = "Korriban", Climate = "dry", Terrain = "desert" }
    };

    public SwapiService(HttpClient httpClient)
    {
        _httpClient = httpClient;
    }

    public async Task<Character?> GetCharacterAsync(string name, CancellationToken cancellationToken = default)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SwapiResponse<Character>>($"people/?search={Uri.EscapeDataString(name)}", cancellationToken);
            var result = response?.Results?.FirstOrDefault();

            if (result != null)
                return result;

            // Fallback to expanded-universe list (case-insensitive contains)
            var fallback = _expandedCharacters.FirstOrDefault(c => c.Name.Contains(name, StringComparison.OrdinalIgnoreCase));
            return fallback;
        }
        catch (OperationCanceledException) when (cancellationToken.IsCancellationRequested)
        {
            throw;
        }
        catch (Exception)
        {
            // On error, try fallback
            var fallback = _expandedCharacters.FirstOrDefault(c => c.Name.Contains(name, StringComparison.OrdinalIgnoreCase));
            return fallback;
        }
    }

    public async Task<List<Starship>?> GetStarshipsAsync(string name, CancellationToken cancellationToken = default)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SwapiResponse<Starship>>($"starships/?search={Uri.EscapeDataString(name)}", cancellationToken);
            var results = response?.Results;
            if (results != null && results.Count > 0)
                return results;

            // Fallback: return expanded starships matching name
            var fallback = _expandedStarships.Where(s => s.Name.Contains(name, StringComparison.OrdinalIgnoreCase)).ToList();
            return fallback.Count > 0 ? fallback : null;
        }
        catch
        {
            var fallback = _expandedStarships.Where(s => s.Name.Contains(name, StringComparison.OrdinalIgnoreCase)).ToList();
            return fallback.Count > 0 ? fallback : null;
        }
    }

    public async Task<List<Planet>?> GetPlanetsAsync(string name, CancellationToken cancellationToken = default)
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SwapiResponse<Planet>>($"planets/?search={Uri.EscapeDataString(name)}", cancellationToken);
            var results = response?.Results;
            if (results != null && results.Count > 0)
                return results;

            var fallback = _expandedPlanets.Where(p => p.Name.Contains(name, StringComparison.OrdinalIgnoreCase)).ToList();
            return fallback.Count > 0 ? fallback : null;
        }
        catch
        {
            var fallback = _expandedPlanets.Where(p => p.Name.Contains(name, StringComparison.OrdinalIgnoreCase)).ToList();
            return fallback.Count > 0 ? fallback : null;
        }
    }

    private class SwapiResponse<T>
    {
        public List<T>? Results { get; set; }
    }
}
